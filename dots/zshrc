# zmodload zsh/zprof # top of your .zshrc file

# set the keyboard mode in terminal (if loaded after the plugins some stuff dont work)
set -o emacs # or vi if you prefer

# load initial stuff
. $ZSH/config
. $ZSH/prompt
. $ZSH/aliases
. $ZSH/completion
. $ZSH/correction
. $ZSH/key_bindings
. $ZSH/plugins/*

# use .localrc for settings specific to one system
[[ -f ~/.localrc ]] && . ~/.localrc

# http://talkings.org/post/5236392664/zsh-and-slow-git-completion
# superfly tnt git autocomplete
# __git_files () {
#   _wanted files expl 'local files' _files
# }

# print current directory to title bar
set_title_and_prompt() {
  # print -Pn "\e]2; ${PWD/#$HOME/~}\a"
  set_prompt
}
precmd () { set_title_and_prompt }
preexec () { set_title_and_prompt }

# fzf
[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh
#export FZF_DEFAULT_COMMAND='ag -g ""'
export FZF_DEFAULT_COMMAND='rg --files --no-ignore-vcs --hidden'

# fasd
eval "$(fasd --init auto)"

# zsh extra syntax highlighting from brew
[ -f /usr/local/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh ] && source /usr/local/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh

# heroku autocomplete setup
HEROKU_AC_ZSH_SETUP_PATH=~/Library/Caches/heroku/autocomplete/zsh_setup && test -f $HEROKU_AC_ZSH_SETUP_PATH && source $HEROKU_AC_ZSH_SETUP_PATH;


lastmod () {
  local result=$(( $(date +"%s") - $(/usr/bin/stat -f "%m" $1) ))
  return result
}

stale () {
  local filename=$1
  local maxminutes=$2
  [[ $(lastmod $filename; echo $?) -gt $maxminutes*60 ]]
}

cacheplease () {
  if [ -f $1 ] && ! stale $1 $2; then
    #echo "exists"
    source $1
  else
    #echo "reload"
    local before=$(ENV)

    # manpath
    export MANPATH="/usr/local/man:/usr/local/mysql/man:/usr/local/git/man:$MANPATH"

    # node modules (npm)
    export PATH="./node_modules/.bin:$PATH"

    # java home
    export JAVA_HOME=$(/usr/libexec/java_home)

    # node path
    export NODE_PATH=$(npm root --quiet -g)

    # go
    export GOROOT=$(brew --prefix golang)/libexec
    export GOPATH=$HOME/go
    export PATH=$GOPATH/bin:${GOROOT}/bin:$PATH

    # nodenv -- use "--no-rehash" for faster initialization
    if which nodenv 1>/dev/null 2>&1; then eval "$(nodenv init - zsh)"; fi

    # pyenv -- use "--no-rehash" for faster initialization
    if which pyenv 1>/dev/null 2>&1; then eval "$(pyenv init - zsh)"; fi

    # elastic beanstalk
    export PATH="$HOME/.ebcli-virtual-env/executables:$PATH"


    local after=$(ENV)

    output=$(comm -23 <(printf '%s\n' $after) <(printf '%s\n' $before))
    echo $output | sed 's/^\(.*\)=\(.*\)$/\1="\2"/' > $1
  fi
}
# cache for X minutes
cacheplease $HOME/.cachedenv 18000

test -e "${HOME}/.iterm2_shell_integration.zsh" && source "${HOME}/.iterm2_shell_integration.zsh"

